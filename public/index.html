<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Occupation Manager Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles & Font Import */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light gray */
            color: #475569; /* Slate-600 for base text */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg text-center">
        <h1 class="text-3xl font-bold text-slate-700 mb-6">Occupation Manager</h1>
        <p class="text-slate-600 mb-6">Please enter your access PIN.</p>

        <div class="space-y-4">
            <div>
                <label for="master-pin" class="block text-sm font-medium text-slate-600 mb-1">Master PIN</label>
                <input type="password" id="master-pin" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-green-300 focus:ring-green-300 sm:text-sm p-2 text-center" placeholder="Enter Master PIN">
                <button onclick="login('master')" class="mt-3 bg-green-400 text-white font-semibold py-2 px-6 rounded-md hover:bg-green-500 transition duration-300 shadow-md w-full">Login as Master</button>
            </div>
            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div>
                <label for="viewer-pin" class="block text-sm font-medium text-slate-600 mb-1">Viewer PIN</label>
                <input type="password" id="viewer-pin" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-cyan-300 focus:ring-cyan-300 sm:text-sm p-2 text-center" placeholder="Enter Viewer PIN">
                <button onclick="login('viewer')" class="mt-3 bg-cyan-400 text-white font-semibold py-2 px-6 rounded-md hover:bg-cyan-500 transition duration-300 shadow-md w-full">Login as Viewer</button>
            </div>
        </div>
        <p id="error-message" class="text-red-500 mt-4 hidden"></p>
    </div>

    <script>
        /**
         * Handles the login process by sending the entered PIN to the Azure Function API.
         * @param {string} roleType - 'master' or 'viewer' to indicate which PIN field was used.
         */
        async function login(roleType) {
            const pinInputId = `${roleType}-pin`;
            const pin = document.getElementById(pinInputId).value;
            const errorMessage = document.getElementById('error-message');
            errorMessage.classList.add('hidden'); // Hide any previous error messages

            if (!pin) {
                errorMessage.textContent = 'Please enter a PIN.';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                // Make a POST request to the AuthPinCheck Azure Function
                const response = await fetch('/api/AuthPinCheck', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pin, roleType }), // Send the PIN and desired role type
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // If login is successful, store the assigned role in sessionStorage
                        sessionStorage.setItem('accessRole', data.role);
                        // Redirect to the appropriate page based on the role
                        if (data.role === 'master') {
                            window.location.href = '/master.html';
                        } else if (data.role === 'viewer') {
                            window.location.href = '/viewer.html';
                        } else {
                            // Fallback for unexpected role
                            errorMessage.textContent = 'Unknown role assigned. Please try again.';
                            errorMessage.classList.remove('hidden');
                        }
                    } else {
                        // Display error message from the API
                        errorMessage.textContent = data.message || 'Invalid PIN.';
                        errorMessage.classList.remove('hidden');
                    }
                } else {
                    // Handle HTTP errors (e.g., 500 server error)
                    errorMessage.textContent = 'An error occurred during login. Please try again.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                // Handle network or other unexpected errors
                console.error('Login error:', error);
                errorMessage.textContent = 'Network error or server issue. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
